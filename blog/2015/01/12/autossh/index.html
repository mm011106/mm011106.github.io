
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>autossh - MQTT and &#8230;</title>
  <meta name="author" content="Masakazu Miyamoto">

  
  <meta name="description" content="sshのコネクションはどうしても切れてしまうことがあるので、それを阻止するためにautosshを使ってみました。
まず、sshのコマンドラインを簡素にするため、MQTTブローカへの接続設定を書いたconfigファイルを用意します。 sshのコンフィギュレーション まずは、 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mm011106.github.io/blog/2015/01/12/autossh/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
   <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="MQTT and ..." type="application/atom+xml">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Lato:400,100,100italic,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:200,300,400,500,600,700,900' rel='stylesheet' type='text/css'>




  

  <style>html{background: url(/images/background.png) no-repeat center center fixed;-webkit-background-size: cover;-moz-background-size: cover;-o-background-size: cover;background-size: cover;}</style>
</head>

<body   >
  <header role="banner"><hgroup>
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">autossh</h1>
    
    
      <p class="meta">
        








  



<time datetime="2015-01-12T08:53:44+09:00" pubdate data-updated="true">2015 / 01 / 12</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>sshのコネクションはどうしても切れてしまうことがあるので、それを阻止するためにautosshを使ってみました。<br/>
まず、sshのコマンドラインを簡素にするため、MQTTブローカへの接続設定を書いたconfigファイルを用意します。</p>

<!-- more -->


<p>sshのコンフィギュレーション</p>

<p>まずは、sshの接続のコマンドラインを簡略化するためにconfigファイルを設定します。<br/>
設定を隠蔽できる（シェルスクリプトなどにパラメタを書かなくてもいい）というてんで良いかなと思います。</p>

<figure class='code'><figcaption><span>~/.ssh/config</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>Host Broker
</span><span class='line'>  HostName        MQTT_Broker
</span><span class='line'>  IdentityFile    ~/.ssh/id_rsa_MQTTClient
</span><span class='line'>  User            MQTT_connection
</span><span class='line'>  LocalForward    <span class="m">22883</span> localhost:1883
</span><span class='line'>  Port            22222
</span></code></pre></td></tr></table></div></figure>


<p>ポート番号などは適宜設定してください。</p>

<p>こうすることで、<code>ssh -f -N Broker</code>のコマンドでトンネリング設定ができます。
ここで、公開鍵はパスフレーズ無しで作ったものを指定します。セキュリティのため、ブローカのssh設定にはポート制限やIP制限、コマンドを実行しないなどの処置を<strong>必ず</strong>とる必要があります。<a href="http://mm011106.github.io/blog/2015/01/11/secure-connection/">設定の具体例</a>（「パスフレーズなしでの接続方法とセキュリティ設定」）</p>

<p>さらに、これが切れたとき自動的に再接続するため、autosshを導入します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'> <span class="nv">$ </span>sudo apt-get install autossh
</span></code></pre></td></tr></table></div></figure>


<p>autosshを使ってトンネリングを設定するには</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'> <span class="nv">$ </span>autossh -M0 -f -N Broker
</span></code></pre></td></tr></table></div></figure>


<p>とします。</p>

<p>-M0 : 接続が切れているかどうかを確認するためのポート指定です。0は切断確認をポートではしないようにする設定です。</p>

<p>-f : 実行をバックグラウンドに移行します。</p>

<p>-N : sshへのオプションです。</p>

<p>autosshはsshを起動してそのプロセスを監視するプロセスを起動するコマンドです。</p>

<p>-Mオプションについては以下のように<a href="http://linux.die.net/man/1/autossh">解説</a>があります。</p>

<blockquote><p>specifies the base monitoring port to use. Without the echo port, this port and the port immediately above it ( port + 1) should be something nothing else is using. autossh will send test data on the base monitoring port, and receive it back on the port above. For example, if you specify &ldquo;-M 20000&rdquo;, autossh will set up forwards so that it can send data on port 20000 and receive it back on 20001.</p>

<p>Alternatively, a port for a remote echo service may be specified. This should be port 7 if you wish to use the standard inetd echo service. When an echo port is specified, only the specified monitor port is used, and it carries the monitor message in both directions.</p>

<p>Many people disable the echo service, or even disable inetd, so check that this service is available on the remote machine. Some operating systems allow one to specify that the service only listen on the localhost (loopback interface), which would suffice for this use.</p>

<p>The echo service may also be something more complicated: perhaps a daemon that monitors a group of ssh tunnels.</p>

<p>Setting the monitor port to 0 turns the monitoring function off, and autossh will only restart ssh upon ssh&rsquo;s exit. For example, if you are using a recent version of OpenSSH, you may wish to explore using the ServerAliveInterval and ServerAliveCountMax options to have the SSH client exit if it finds itself no longer connected to the server. In many ways this may be a better solution than the monitoring port.</p></blockquote>

<p>ということなので、0を指定するとsshがexitした時に再起動します。接続はServerAliveIntervalとServerAliveCountMaxだけ待って応答が来なければexitするので、その場合sshが再起動されるという事でしょう。「この方法がポートモニタするより良い方法だ」といっているので、そうすることにします。</p>

<p>sshのデフォルト<a href="http://www.unixuser.org/~euske/doc/openssh/jman/ssh_config.html">設定</a>では<code>ServerAliveInterval</code>は0になっている(確認のメッセージを送らない）ようなので、適宜設定する必要があります。<br/>
これがまたちょっと厄介ですね。あまり頻繁にパケットを送ると電話回線などプレミアムな回線を使っているときにコストがかさみます。本来はきちんとTPOで設定する必要があると思いますが、とりあえず30秒ぐらいに設定しておきます。</p>

<figure class='code'><figcaption><span>configに追記</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#  connection alive detecting. 30 x 3 [s]</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'>ServerAliveInterval   30
</span><span class='line'>ServerAliveCountMax   3
</span></code></pre></td></tr></table></div></figure>


<p><code>ServerAliveCountMax</code>は3がデフォルトのようですので、応答がなくなったあと1分30秒で切断されるようになります。</p>

<p>これで、ちゃんと接続できるか確認してみます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>ps ax <span class="p">|</span> grep <span class="s1">&#39;ssh&#39;</span>
</span><span class='line'> <span class="m">6543</span> ?        Ss     0:00 /usr/lib/autossh/autossh -M0 -N Broker
</span><span class='line'> <span class="m">6544</span> ?        S      0:00 /usr/bin/ssh -N Broker
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>mosquitto_sub -v -p <span class="m">22883</span> -t <span class="s1">&#39;$SYS/#&#39;</span>
</span><span class='line'><span class="nv">$SYS</span>/broker/version mosquitto version 1.3.5
</span><span class='line'><span class="nv">$SYS</span>/broker/timestamp 2014-10-18 21:06:44+0100
</span><span class='line'> :
</span><span class='line'> :
</span></code></pre></td></tr></table></div></figure>


<p>Okですね。
さらに、keepalive確認のパケットがどのように出ているか確認してみます。</p>

<p>IPアドレスは下記のようになっています。<br/>
192.168.0.XXX クライアント<br/>
192.168.0.YYY サーバ</p>

<figure class='code'><figcaption><span>Keep Alive packets example</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>No.     Time        Source                Destination           Protocol Length Info
</span><span class='line'>      <span class="m">1</span> 0.000000    192.168.0.XXX         192.168.0.YYY           TCP      <span class="m">130</span>    <span class="m">41387</span> &gt; SSHPORT　 <span class="o">[</span>PSH, ACK<span class="o">]</span>
</span><span class='line'>      <span class="m">2</span> 0.010903    192.168.0.YYY         192.168.0.XXX           TCP      <span class="m">98</span>     SSHPORT &gt; <span class="m">41387</span> <span class="o">[</span>PSH, ACK<span class="o">]</span>
</span><span class='line'>      <span class="m">3</span> 0.010941    192.168.0.XXX         192.168.0.YYY           TCP      <span class="m">66</span>     <span class="m">41387</span> &gt; SSHPORT <span class="o">[</span>ACK<span class="o">]</span>
</span><span class='line'>      <span class="m">4</span> 30.039772   192.168.0.XXX         192.168.0.YYY           TCP      <span class="m">130</span>    <span class="m">41387</span> &gt; SSHPORT <span class="o">[</span>PSH, ACK<span class="o">]</span>
</span><span class='line'>      <span class="m">5</span> 30.043964   192.168.0.YYY         192.168.0.XXX           TCP      <span class="m">98</span>     SSHPORT &gt; <span class="m">41387</span> <span class="o">[</span>PSH, ACK<span class="o">]</span>
</span><span class='line'>      <span class="m">6</span> 30.044004   192.168.0.XXX         192.168.0.YYY           TCP      <span class="m">66</span>     <span class="m">41387</span> &gt; SSHPORT <span class="o">[</span>ACK<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>30秒ごとに何かしらのパケットをやり取りしていることがわかりました。設定通りです。</p>

<p>さらに、途中で回線を切断してみます。</p>

<figure class='code'><figcaption><span>Packet example (in case of disconnection)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>No.     Time        Source                Destination           Protocol Length Info
</span><span class='line'><span class="c">#　正常なalive確認のパケットやり取り</span>
</span><span class='line'>      <span class="m">1</span> 0.000000    192.168.0.XXX         192.168.0.YYY         TCP      <span class="m">130</span>    <span class="m">41405</span> &gt; SSHPORT <span class="o">[</span>PSH, ACK<span class="o">]</span>
</span><span class='line'>      <span class="m">2</span> 0.002137    192.168.0.YYY         192.168.0.XXX         TCP      <span class="m">66</span>     SSHPORT &gt; <span class="m">41405</span> <span class="o">[</span>ACK<span class="o">]</span>
</span><span class='line'>      <span class="m">3</span> 0.002566    192.168.0.YYY         192.168.0.XXX         TCP      <span class="m">98</span>     SSHPORT &gt; <span class="m">41405</span> <span class="o">[</span>PSH, ACK<span class="o">]</span>
</span><span class='line'>      <span class="m">4</span> 0.041204    192.168.0.XXX         192.168.0.YYY         TCP      <span class="m">66</span>     <span class="m">41405</span> &gt; SSHPORT <span class="o">[</span>ACK<span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c">#　ここで回線を切断　sshがシャットダウンするまで130秒ぐらい待ち、回線を復旧させる</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#  sshがautosshによって再起動されて通信を開始</span>
</span><span class='line'>
</span><span class='line'><span class="c"># 切断前のコネクションをリセット</span>
</span><span class='line'>      <span class="m">5</span> 138.686269  192.168.0.XXX         192.168.0.YYY         TCP      <span class="m">258</span>    <span class="m">41405</span> &gt; SSHPORT <span class="o">[</span>FIN, PSH, ACK<span class="o">]</span>
</span><span class='line'>      <span class="m">6</span> 138.687686  192.168.0.YYY         192.168.0.XXX         TCP      <span class="m">98</span>     SSHPORT &gt; <span class="m">41405</span> <span class="o">[</span>PSH, ACK<span class="o">]</span>
</span><span class='line'>      <span class="m">7</span> 138.687721  192.168.0.XXX         192.168.0.YYY         TCP      <span class="m">54</span>     <span class="m">41405</span> &gt; SSHPORT <span class="o">[</span>RST<span class="o">]</span>
</span><span class='line'>      <span class="m">8</span> 138.689209  192.168.0.YYY         192.168.0.XXX         TCP      <span class="m">130</span>    SSHPORT &gt; <span class="m">41405</span> <span class="o">[</span>FIN, PSH, ACK<span class="o">]</span>
</span><span class='line'>      <span class="m">9</span> 138.689233  192.168.0.XXX         192.168.0.YYY         TCP      <span class="m">54</span>     <span class="m">41405</span> &gt; SSHPORT <span class="o">[</span>RST<span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c">#　新たなコネクションのスタート</span>
</span><span class='line'>     <span class="m">10</span> 148.955582  192.168.0.XXX         192.168.0.YYY         TCP      <span class="m">74</span>     <span class="m">41407</span> &gt; SSHPORT <span class="o">[</span>SYN<span class="o">]</span>
</span><span class='line'>     <span class="m">11</span> 148.958766  192.168.0.YYY         192.168.0.XXX         TCP      <span class="m">74</span>     SSHPORT &gt; <span class="m">41407</span> <span class="o">[</span>SYN, ACK<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>という感じになりました。何回か試して見ましたが、切断前のコネクションをリセットするやり取りがない場合が多いかもしれません。さらに、alive確認のパケットは2往復でなく1往復半という事もありました。</p>

<p>無事sshの再起動も確認出来ました。</p>

<p>接続確認のためのパケットのサイズは、今回の実験では360byteぐらいでした。もしこの設定（30秒に1回）だとすると1日で1Mbyteぐらいの通信量です。
最近の安いデータ通信用のSIMにとってみれば大したデータ量ではないかもしれませんね。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Masakazu Miyamoto</span></span>

      








  



<time datetime="2015-01-12T08:53:44+09:00" pubdate data-updated="true">2015 / 01 / 12</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/autossh/'>autossh</a>, <a class='category' href='/blog/categories/ssh/'>ssh</a>, <a class='category' href='/blog/categories/tunneling/'>tunneling</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mm011106.github.io/blog/2015/01/12/autossh/" data-via="" data-counturl="http://mm011106.github.io/blog/2015/01/12/autossh/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/01/11/secure-connection/" title="Previous Post: 接続の暗号化">&laquo; 接続の暗号化</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/01/13/ipaddress/" title="Next Post: 自分のIPアドレスを送信する">自分のIPアドレスを送信する &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section id="titles">
  <a href="http://mm011106.github.io" title="MQTT and ..."><img id="logo" src="http://mm011106.github.io/images/logo2.png" /></a>
  <h1 id="site_title"><a href="http://mm011106.github.io" title="MQTT and ...">MQTT and &#8230;</a></h1>
  <h3 id="site_subtitle">My first step to the IoT world.</h3>
</section>

<section id="menu">
  <ul>
    <li><i class="fa fa-home fa-lg"></i><a href="http://mm011106.github.io"> Home </a></li>
    <li><i class="fa fa-calendar fa-lg"></i><a href="http://mm011106.github.io/blog/archives/"> Archives </a></li>
    <li><i class="fa fa-user fa-lg"></i><a href="http://mm011106.github.io/about/"> About </a></li>
    <li><i class="fa fa-rss fa-lg"></i><a href="http://mm011106.github.io/atom.xml"> Feed </a></li>
  </ul>
</section>

<section id="social">
  

  

  

  

  

  
</section>


<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/01/25/webcam/">WebCamをつなげてみる</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/21/update-mosquitto/">mosquittoをアップデートする</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/18/ore-ore-certificate/">オレオレ証明書を作ってみようかと　準備</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/13/ipaddress/">自分のIPアドレスを送信する</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/12/autossh/">autossh</a>
      </li>
    
  </ul>
</section>

<!-- #<section id="titles">
  <a href="http://mm011106.github.io" title="MQTT and ..."><img id="logo" src="http://mm011106.github.io/images/logo2.png" /></a>
  <h1 id="site_title"><a href="http://mm011106.github.io" title="MQTT and ...">MQTT and &#8230;</a></h1>
  <h3 id="site_subtitle">My first step to the IoT world.</h3>
</section>

<section id="menu">
  <ul>
    <li><i class="fa fa-home fa-lg"></i><a href="http://mm011106.github.io"> Home </a></li>
    <li><i class="fa fa-calendar fa-lg"></i><a href="http://mm011106.github.io/blog/archives/"> Archives </a></li>
    <li><i class="fa fa-user fa-lg"></i><a href="http://mm011106.github.io/about/"> About </a></li>
    <li><i class="fa fa-rss fa-lg"></i><a href="http://mm011106.github.io/atom.xml"> Feed </a></li>
  </ul>
</section>

<section id="social">
  

  

  

  

  

  
</section>
 &#8211;>

<h1> test for a linke </h1>

<!-- <section>
  <h1>Test for a link to a new page</h1>
  <ul id="references">
    
      <li class="post">
        <a href="/blog/2015/01/25/webcam/">WebCamをつなげてみる</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/21/update-mosquitto/">mosquittoをアップデートする</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/18/ore-ore-certificate/">オレオレ証明書を作ってみようかと　準備</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/13/ipaddress/">自分のIPアドレスを送信する</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/01/12/autossh/">autossh</a>
      </li>
    
  </ul>
</section>

&#8211;>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Masakazu Miyamoto -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
