
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>autosshでポートフォワード - MQTT and &#8230;</title>
  <meta name="author" content="Masakazu Miyamoto">

  
  <meta name="description" content="以前、ポーフォワードをautosshで設定するというのをやりましたが、今回はそれをもう少しまとめてみました。
起動スクリプトの理解を少し深めて、さらにポートフォワード用のユーザを作ってそこで実行するようにして見ました。 何をするのか？ 今回の目標は、エッジデバイス側の暗号化経路を確立するために、 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mm011106.github.io/blog/2015/02/21/autossh-2/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
   <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="MQTT and ..." type="application/atom+xml">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Lato:400,100,100italic,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:200,300,400,500,600,700,900' rel='stylesheet' type='text/css'>




  

  <style>html{background: url(/images/background.png) no-repeat center center fixed;-webkit-background-size: cover;-moz-background-size: cover;-o-background-size: cover;background-size: cover;}</style>
</head>

<body   >
  <header role="banner"><hgroup>
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">autosshでポートフォワード</h1>
    
    
      <p class="meta">
        








  



<time datetime="2015-02-21T18:16:46+09:00" pubdate data-updated="true">2015 / 02 / 21</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>以前、ポーフォワードを<a href="http://mm011106.github.io/blog/2015/01/12/autossh/">autosshで設定する</a>というのをやりましたが、今回はそれをもう少しまとめてみました。<br/>
起動スクリプトの理解を少し深めて、さらにポートフォワード用のユーザを作ってそこで実行するようにして見ました。</p>

<!-- more -->


<h2>何をするのか？</h2>

<p>今回の目標は、エッジデバイス側の暗号化経路を確立するために、システム起動時にサーバ（ここではブローカ）にsshでポートフォワードを設定することです。
さらにセキュリティ向上を目指して、ポートフォワードのプロセスを起動する専用のユーザを設定しています。</p>

<p>手順としては、</p>

<ul>
<li>ユーザを作る</li>
<li>そのユーザ上にsshのconfigファイルを設定</li>
<li>パスフレーズなしの鍵を作る</li>
<li>接続テスト</li>
<li>init.d用スクリプトを作成〜登録</li>
<li>起動テスト</li>
</ul>


<p>となりました。</p>

<p>以下のパラメタを決定しておきます。
()内には、この例での値を書いておきます。</p>

<ul>
<li>サーバ名(mybroker)</li>
<li>サーバのアカウント名(pipipi)</li>
<li>サーパのsshポート(sshport)</li>
<li>サーバのMQTTポート(1883)</li>
<li>パスフレーズなしの鍵 (mqttclient_key)</li>
<li>ローカルのMQTT用ポート(22883)</li>
<li>ポートフォワード用ユーザ(pfuser)</li>
</ul>


<p>ハードウエアはRaspberry Pi、OSはRaspbianを想定しています。</p>

<h2>ポートフォワード用ユーザを作成</h2>

<p>まずは、ポートフォワード用ユーザを作ります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'> <span class="nv">$ </span>sudo useradd -m pfuser
</span></code></pre></td></tr></table></div></figure>


<p>このオプションだとユーザのホームディレクトリだけが作成されます。パスワードが設定されていませんので、ログインできない状態（ロック状態）となっています。<br/>
ユーザ設定のデフォルト値は<code>useradd -D</code>で表示できるようですので、確認しておきましょ。</p>

<p>このユーザにはログインできない状態のはずです。一応、外からsshで接続してみます。。。。<br/>
やはりできませんね。ok<br/>
さらに、コマンドからユーザの設定を確認しておきます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'> <span class="nv">$ </span>passwd -S pfuser
</span><span class='line'>pfuser L 02/21/2015 <span class="m">0</span> <span class="m">99999</span> <span class="m">7</span> -1
</span></code></pre></td></tr></table></div></figure>


<p>2番目にLとありますが、これがロックされているアカウント、という意味のようです。</p>

<p>次に、作ったユーザのホームディレクトリに以下のものを作ります。</p>

<ul>
<li>パスフレーズなしの鍵</li>
<li>ssh用のconfiファイル作成</li>
</ul>


<h2>パスフレーズなしの鍵を作る</h2>

<p>他のユーザで鍵を作ってコピーしてもいいですが、ユーザ名の変更とかしなきゃいけない(<code>chown usr:grp</code>)ので、素直にポートフォワード用ユーザ(pfuser)に移動して鍵を作ります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo su - pfuser
</span><span class='line'><span class="c"># 今のユーザからpfuser（今作ったポートフォワード用ユーザ）に移動</span>
</span><span class='line'><span class="c"># &#39;-&#39; optionでログインしたのと同じ状態</span>
</span><span class='line'><span class="c">#  （ホームに移動して環境変数も初期化される）になる</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>mkdir .ssh
</span><span class='line'><span class="nv">$ </span><span class="nb">cd</span> .ssh
</span><span class='line'><span class="nv">$ </span>ssh-keygen -f mqttclient_key
</span><span class='line'><span class="c"># パスフレーズを入力するように言われますが、ただenterを押してやることで</span>
</span><span class='line'><span class="c"># パスフレーズなしの鍵ができます</span>
</span></code></pre></td></tr></table></div></figure>


<p>(以後しばらくこのユーザで作業します。)</p>

<p>作った鍵の公開鍵の方を(<code>mqttclient_key.pub</code>)をサーバ側にコピーします。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>scp -P sshport ./mqttclient_key.pub pipipi@mybroker:~/.ssh/
</span><span class='line'><span class="nv">$ </span>ssh pipipi@mybroker
</span><span class='line'>mybroker <span class="nv">$ </span><span class="nb">echo</span> -n <span class="s1">&#39;no-pty,permitopen=&quot;localhost:1883&quot;,command=&quot;/bin/false&quot; &#39;</span> &gt;&gt; authorized_keys
</span><span class='line'><span class="c"># これは、パスフレーズなしの鍵でログインした場合の動作を制限するおまじないです。</span>
</span><span class='line'>mybroker <span class="nv">$ </span>cat .ssh/mqttclient_key.pub &gt;&gt; authorized_keys
</span><span class='line'><span class="c"># 鍵を登録します</span>
</span><span class='line'>mybroker <span class="nv">$ </span><span class="nb">exit</span>
</span></code></pre></td></tr></table></div></figure>


<p>これで、サーバに鍵を登録しましたので、試しに接続してみます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>ssh -i ~/.ssh/mqttclient_key pipipi@mybroker
</span><span class='line'>PTY allocation request failed on channel 0
</span><span class='line'>Connection to xxx.xxx.xxx.xxx closed.
</span></code></pre></td></tr></table></div></figure>


<p>となれば成功です。これは、先程の鍵の登録の時のおまじないで、コンソールが開かないようにno-ptyでオフにしたこと、またコマンド入力を受け付けないようにシェルを空のシェルプログラムにしたことでコネクションがフェイルしているためです。</p>

<h2>sshの設定ファイルを作る</h2>

<p>次に、sshのポートフォワード設定ファイルをつくります。コマンドラインからすべてのパラメタを入れてもいいのですけれど、結構長くなってしまうのと、psでプロセスを表示した時にパラメタが全部見えてしまうのでなんとなく気持ち悪いのでこうします。</p>

<p>viなどのエディタで以下のような内容のファイルを<code>~/.ssh/config</code>として作ります。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#  MQTT portforwarding config</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'>
</span><span class='line'>ServerAliveInterval   30
</span><span class='line'>ServerAliveCountMax   3
</span><span class='line'>
</span><span class='line'>StrictHostKeyChecking  no
</span><span class='line'>
</span><span class='line'>Host Broker
</span><span class='line'>  HostName        mybroker
</span><span class='line'>  IdentityFile    /home/pfuser/.ssh/mqttlient_key
</span><span class='line'>  User            pipipi
</span><span class='line'>  LocalForward    <span class="m">22883</span> localhost:1883
</span><span class='line'>  Port            sshport
</span></code></pre></td></tr></table></div></figure>


<p>このようにすることで、sshのマンドオプションに&#8217;Broker&#8217;と指定するだけで接続できるようになります。</p>

<p>最初の2行の設定は、コネクションを確認するための設定で、</p>

<blockquote><p>30秒に1回コネクションがあることを確認するためのパケットを送ります。もしこれが3回繰り返して通らない場合（コネクションがダウンしている場合）、接続を切ります。</p></blockquote>

<p>という設定です。</p>

<p>つまり、これで30秒x3=1分30秒間連続してコネクションが切れていると、sshはダウンします。</p>

<p>StrictHostKeyCheckingはクライアント側のknown_hostsに接続先の登録がないときに「ほんとに接続していいのかよ」と聞いてくるのを抑えます。このメッセージが出てしまうとスクリプトで実行した時にエラーで止まってしまいます。今回の場合は明示的に鍵をサーバにコピーしていますし、騙されたりして違うサーバに接続することはないと思うので、このように指定しました。</p>

<p>Host以降は接続名に対応する設定を記入します。IdentityFileはフルパスのほうが後々トラブルが少ないとおもうので、そうしておきました。</p>

<p>ここまでできたら、このconfigファイルを使って接続を試してみます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>ssh -f -N -F /home/pfuser/.ssh/config Broker
</span></code></pre></td></tr></table></div></figure>


<p>-f は起動後バックグラウンドに移動させるためのオプションです。-N は接続先でコマンドを起動しない設定です。<br/>
エラーせずプロンプトが帰ってくれば成功している可能性大です。psコマンドで確認してみます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>ps ax <span class="p">|</span> grep <span class="s1">&#39;ssh&#39;</span>
</span><span class='line'> <span class="m">3100</span> ?        S      0:00 ssh -f -N -F /home/pfuser/.ssh/config Broker
</span></code></pre></td></tr></table></div></figure>


<p>のように先のコマンドラインが出てくればokです。</p>

<p>exitして元のユーザに戻っておきます。</p>

<h2>init.d用のスクリプトを書く</h2>

<p>これがちょっと曲者なので、検索して<a href="http://files.bogosity.se/autossh_tunnel.foo">動きそうなスクリプト</a>を探してきました。これに適宜必要な部分を書きたして見ました。</p>

<p>ファイル名を<code>mqtt-pf</code>として下記の内容を<code>/etc/init.d/</code>に作成します。</p>

<p>su でやる必要がありますので、念の為。</p>

<p><a href="https://raw.githubusercontent.com/mm011106/mqtt-pf/master/mqtt-pf">mqtt-pf</a></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#! /bin/sh</span>
</span><span class='line'><span class="c">### BEGIN INIT INFO</span>
</span><span class='line'><span class="c"># Provides:          mqtt-pf</span>
</span><span class='line'><span class="c"># Required-Start:    $syslog $network $all </span>
</span><span class='line'><span class="c"># Required-Stop:     $syslog $network</span>
</span><span class='line'><span class="c"># Default-Start:     2 3 4 5</span>
</span><span class='line'><span class="c"># Default-Stop:      0 1 6</span>
</span><span class='line'><span class="c"># Short-Description: Port forward for MQTT protocol</span>
</span><span class='line'><span class="c">### END INIT INFO</span>
</span><span class='line'>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Author: Andreas Olsson &lt;andreas@arrakis.se&gt;</span>
</span><span class='line'><span class="c"># Version:    @(#)autossh_tunnel.foo  0.1  27-Aug-2008  andreas@arrakis.se</span>
</span><span class='line'><span class="c"># modified :    13-Feb-2015 mqtt.and@gmail.com </span>
</span><span class='line'><span class="c">#            </span>
</span><span class='line'><span class="c">#           </span>
</span><span class='line'><span class="c"># For each tunnel; make a uniquely named copy of this template.</span>
</span><span class='line'>
</span><span class='line'><span class="c">## SETTINGS</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># specify a host name in ~/.ssh/config,</span>
</span><span class='line'><span class="c"># and also the ssh-key for connection must be located in ~/.ssh/</span>
</span><span class='line'><span class="nv">TUNNEL</span><span class="o">=</span><span class="s2">&quot;Broker&quot;</span>
</span><span class='line'><span class="c"># You must use the real autossh binary, not a wrapper.</span>
</span><span class='line'><span class="nv">DAEMON</span><span class="o">=</span>/usr/lib/autossh/autossh
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">## END SETTINGS</span>
</span><span class='line'>
</span><span class='line'><span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
</span><span class='line'>
</span><span class='line'><span class="nv">NAME</span><span class="o">=</span><span class="sb">`</span>basename <span class="nv">$0</span><span class="sb">`</span>
</span><span class='line'><span class="c"># NAME is always including the extension of $0</span>
</span><span class='line'><span class="c"># the script should be named without extension for good looking</span>
</span><span class='line'><span class="nv">PIDFILE</span><span class="o">=</span>/var/run/<span class="k">${</span><span class="nv">NAME</span><span class="k">}</span>.pid
</span><span class='line'><span class="nv">SCRIPTNAME</span><span class="o">=</span>/etc/init.d/<span class="k">${</span><span class="nv">NAME</span><span class="k">}</span>
</span><span class='line'><span class="nv">DESC</span><span class="o">=</span><span class="s2">&quot;SSH Tunnel for MQTT protocol&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># exit when test result = false</span>
</span><span class='line'><span class="nb">test</span> -x <span class="nv">$DAEMON</span> <span class="o">||</span> <span class="nb">exit </span>0
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">MQTT_PF_PIDFILE</span><span class="o">=</span><span class="k">${</span><span class="nv">PIDFILE</span><span class="k">}</span>
</span><span class='line'><span class="nv">ASOPT</span><span class="o">=</span><span class="s2">&quot;-M 0 -N -F /home/pfuser/.ssh/config &quot;</span><span class="k">${</span><span class="nv">TUNNEL</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Function that starts the daemon/service.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c">#  ssh command is not able to make a pid file with -f (force background) option.</span>
</span><span class='line'><span class="c">#  To obtain pid file properly, put --background, --make-pidfile option on the start-stop-deamon command,</span>
</span><span class='line'><span class="c">#    --background option is forcing ssh process started without -f option into background.</span>
</span><span class='line'>
</span><span class='line'>d_start<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  start-stop-daemon --start --quiet --chuid pfuser:pfuser --user pfuser --background --pidfile <span class="nv">$PIDFILE</span> <span class="se">\</span>
</span><span class='line'>      --make-pidfile --exec <span class="nv">$DAEMON</span> -- <span class="nv">$ASOPT</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -gt <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</span><span class='line'>      <span class="nb">echo</span> -n <span class="s2">&quot; not started (or already running)&quot;</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      sleep 1
</span><span class='line'>      start-stop-daemon --stop --quiet --pidfile <span class="nv">$PIDFILE</span> <span class="se">\</span>
</span><span class='line'>      --test --exec <span class="nv">$DAEMON</span> &gt; /dev/null <span class="o">||</span> <span class="nb">echo</span> -n <span class="s2">&quot; not started&quot;</span>
</span><span class='line'>  <span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Function that stops the daemon/service.</span>
</span><span class='line'>d_stop<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  start-stop-daemon --stop --quiet --pidfile <span class="nv">$PIDFILE</span> <span class="se">\</span>
</span><span class='line'>      --exec <span class="nv">$DAEMON</span> <span class="se">\</span>
</span><span class='line'>      <span class="o">||</span> <span class="nb">echo</span> -n <span class="s2">&quot; not running&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="s2">&quot;$1&quot;</span> in
</span><span class='line'>  start<span class="o">)</span>
</span><span class='line'>  <span class="nb">echo</span> -n <span class="s2">&quot;Starting $DESC: $NAME&quot;</span>
</span><span class='line'>  d_start
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;.&quot;</span>
</span><span class='line'>  <span class="p">;;</span>
</span><span class='line'>  stop<span class="o">)</span>
</span><span class='line'>  <span class="nb">echo</span> -n <span class="s2">&quot;Stopping $DESC: $NAME&quot;</span>
</span><span class='line'>  d_stop
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;.&quot;</span>
</span><span class='line'>  <span class="p">;;</span>
</span><span class='line'>
</span><span class='line'>  restart<span class="o">)</span>
</span><span class='line'>  <span class="nb">echo</span> -n <span class="s2">&quot;Restarting $DESC: $NAME&quot;</span>
</span><span class='line'>  d_stop
</span><span class='line'>  sleep 1
</span><span class='line'>  d_start
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;.&quot;</span>
</span><span class='line'>  <span class="p">;;</span>
</span><span class='line'>  *<span class="o">)</span>
</span><span class='line'>  <span class="nb">echo</span> <span class="s2">&quot;Usage: $SCRIPTNAME {start|stop|restart}&quot;</span> &gt;<span class="p">&amp;</span>2
</span><span class='line'>  <span class="nb">exit </span>3
</span><span class='line'>  <span class="p">;;</span>
</span><span class='line'><span class="k">esac</span>
</span><span class='line'>
</span><span class='line'><span class="nb">exit </span>0
</span></code></pre></td></tr></table></div></figure>


<p>ファイルができたら、実行できるようにパーミッションを設定します。</p>

<p>このスクリプトではautosshを起動しています。ssh をラップするコマンドで、sshを監視して、止まったら再起動するという事をしてくれます。基本的にsshコマンドが先のテストの時に動けば、問題なくautosshも起動できるはずです。</p>

<p>最初のコメント欄では、このスクリプトの起動の順番を指定しています。</p>

<ul>
<li><code># Provides:          mqtt-pf</code>

<ul>
<li>このスクリプトの名前です</li>
</ul>
</li>
<li><code># Required-Start:    $syslog $network $all</code>

<ul>
<li>このスクリプトを起動するときに必要な環境（バーチャルファシリティ）を指定</li>
</ul>
</li>
</ul>


<p>この指定がまたまた曲者で、うまく指定しないと起動してくれません。今回は色々試行錯誤して$allというファシリティを指定しました。すべての起動するべきスクリプトが実行されたあとに実行されるようになります。</p>

<p>$networkだけだと、dhcpが実行される前に実行されたりしてうまく行きませんでした。</p>

<p>実際にデーモンを起動するコマンド(start-stop-daemon)は以下のような設定になっています。</p>

<ul>
<li>&ndash;chuid pfuser:pfuser

<ul>
<li>ユーザ、グループIDを&#8217;pfuser、pfuser&#8217;で起動する</li>
</ul>
</li>
<li>&ndash;user pfuser

<ul>
<li>プロセスチェックするときのプロセスのユーザ指定(pfuserを指定）</li>
</ul>
</li>
<li>&ndash;background

<ul>
<li>バックグラウンドに移行</li>
</ul>
</li>
<li>&ndash;pidfile $PIDFILE

<ul>
<li>PIDを記録するファイルを指定</li>
</ul>
</li>
<li>&ndash;make-pidfile

<ul>
<li>PID ファイルを作るように指定</li>
</ul>
</li>
<li>&ndash;exec $DAEMON &ndash; $ASOPT

<ul>
<li>デーモンとして起動するコマンドとそれに渡すためのオプション</li>
</ul>
</li>
</ul>


<p>通常は&ndash;make-pidfileと&ndash;backgroundは不要のようですが、一応つけてあります。
コメントにもあるように、一部のコマンドはバックグラウンドに移行できないものがあり、それを強制するための&ndash;background オプションです。さらにこのオプションを指定した時にpidファイルが作られないことがあるそうなので、その対策として明示的にpidファイルをつるくように指定していています。</p>

<p>autosshコマンドに渡しているオプションは以下のとおりです。</p>

<ul>
<li>-M 0

<ul>
<li>接続が確立しているかどうかのチェックをするためのポート番号を指定</li>
<li>0はポートを使った接続チェックをしないで、sshコマンドが停止した時のみ再起動するという指定です。</li>
</ul>
</li>
<li>-N

<ul>
<li>これ以降のオプションはsshにそのまま渡されます。</li>
<li>N　は接続先のコマンドを起動しない指定です。</li>
</ul>
</li>
<li>-F /home/pfuser/.ssh/config

<ul>
<li>設定ファイルの指定です。ユーザを指定しているので不要かもしれません。</li>
</ul>
</li>
</ul>


<p>ここまでできたら、単体でこのスクリプトを動かしてみます。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo /etc/init.d/mqtt-pf start
</span><span class='line'>Starting SSH Tunnel <span class="k">for</span> MQTT protocol: mqtt-pf.
</span></code></pre></td></tr></table></div></figure>


<p>と出てくれば成功です。</p>

<p><code>...not started.</code></p>

<p>となると失敗です。設定を見なおしてください。特にコメントで指定しているファシリティがきちんとしているか、pidができているか。など。<br/>
一応、このスクリプトは動作確認していますので、動くと思いますけど。。。。</p>

<h2>rc.dに登録</h2>

<p>ここまで行けば、だいたい大丈夫だとおもいます。</p>

<p>起動スクリプトの一部として、このポートフォワード設定を登録します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo update-rc.d mqtt-pf defaults
</span><span class='line'><span class="c"># として、登録</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>ls /etc/rc2.d
</span><span class='line'><span class="c">#　とすると、どの順番で起動することになるかがわかります。</span>
</span><span class='line'><span class="c">#  S04mqtt-pfというファイル名になっていれば大丈夫かとおもいます。</span>
</span></code></pre></td></tr></table></div></figure>


<p>rc2.dのディレクトリにあるスクリプト（へのリンク）はランレベル２の時に起動/停止するデーモンのための起動/停止スクリプトです。</p>

<p>Sで始まるスクリプトが起動用、Kで始まるスクリプトが停止用、番号が順番です。小さい方から順に実行されていきます。$allというファシリティを指定したので主要なスクリプトはすべて実行（起動）されたあとに起動されるようになっていて、大きめの番号が付いているはずです。</p>

<p>ここまでくれば、あとはリブートするだけです。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo reboot
</span></code></pre></td></tr></table></div></figure>


<p>起動メッセージに</p>

<p><code>Starting SSH Tunnel for MQTT protocol: mqtt-pf. </code></p>

<p>と出てくれば成功です。多分。
ログインして、psで確認してみてください。</p>

<p>ずっとうまく行ってて、再起動だけうまく行かないという時は、パーミッションや設定ファイルの指定がうまく行っていない場合が多いです。</p>

<p>起動時はすべてrootで実行されますので、ユーザとして実行している状態とはちょっと違っています。そこら辺を気にかけながらデバグすると効率がいいかと思います。</p>

<p>以上！</p>

<p>ここまでたどり着くのに丸３日以上の時間がかかりました。。。。ユーザで実行してうまく起動するけれど、起動スクリプトに登録するとうまく動かない、というところで約２日を消費。あ〜、やっとできた。</p>

<p>ポイントは「rootユーザが実行する」という点と「接続先からなにか聞かれる場合がある」という点です。</p>

<p>おかげで、起動スクリプトは結構詳しくなりました。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Masakazu Miyamoto</span></span>

      








  



<time datetime="2015-02-21T18:16:46+09:00" pubdate data-updated="true">2015 / 02 / 21</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/autossh/'>autossh</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mm011106.github.io/blog/2015/02/21/autossh-2/" data-via="" data-counturl="http://mm011106.github.io/blog/2015/02/21/autossh-2/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/02/08/remote-stillcam/" title="Previous Post: Paho mqttでリモートカメラ">&laquo; Paho mqttでリモートカメラ</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/02/23/init-dot-d-script/" title="Next Post: init.dスクリプトを書いてみる">init.dスクリプトを書いてみる &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section id="titles">
  <a href="http://mm011106.github.io" title="MQTT and ..."><img id="logo" src="http://mm011106.github.io/images/logo2.png" /></a>
  <h1 id="site_title"><a href="http://mm011106.github.io" title="MQTT and ...">MQTT and &#8230;</a></h1>
  <h3 id="site_subtitle">My first step to the IoT world.</h3>
</section>

<section id="menu">
  <ul>
    <li><i class="fa fa-home fa-lg"></i><a href="http://mm011106.github.io"> Home </a></li>
    <li><i class="fa fa-calendar fa-lg"></i><a href="http://mm011106.github.io/blog/archives/"> Archives </a></li>
    <li><i class="fa fa-user fa-lg"></i><a href="http://mm011106.github.io/about/"> About </a></li>
    <li><i class="fa fa-rss fa-lg"></i><a href="http://mm011106.github.io/atom.xml"> Feed </a></li>
  </ul>
</section>

<section id="social">
  

  

  

  

  

  
</section>


<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/03/08/send-email-via-gmail/">gmailでメールを送る</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/28/autossh-failure-to-connect/">autosshが起動スクリプトでうまく動かない訳</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/28/preview-md/">mdファイルのプレビュー</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/25/read-env-in-init-dot-d/">起動スクリプトで環境変数を読み込む</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/23/init-dot-d-script/">init.dスクリプトを書いてみる</a>
      </li>
    
  </ul>
</section>

<!-- #<section id="titles">
  <a href="http://mm011106.github.io" title="MQTT and ..."><img id="logo" src="http://mm011106.github.io/images/logo2.png" /></a>
  <h1 id="site_title"><a href="http://mm011106.github.io" title="MQTT and ...">MQTT and &#8230;</a></h1>
  <h3 id="site_subtitle">My first step to the IoT world.</h3>
</section>

<section id="menu">
  <ul>
    <li><i class="fa fa-home fa-lg"></i><a href="http://mm011106.github.io"> Home </a></li>
    <li><i class="fa fa-calendar fa-lg"></i><a href="http://mm011106.github.io/blog/archives/"> Archives </a></li>
    <li><i class="fa fa-user fa-lg"></i><a href="http://mm011106.github.io/about/"> About </a></li>
    <li><i class="fa fa-rss fa-lg"></i><a href="http://mm011106.github.io/atom.xml"> Feed </a></li>
  </ul>
</section>

<section id="social">
  

  

  

  

  

  
</section>
 &#8211;>

<h1> test for a linke </h1>

<!-- <section>
  <h1>Test for a link to a new page</h1>
  <ul id="references">
    
      <li class="post">
        <a href="/blog/2015/03/08/send-email-via-gmail/">gmailでメールを送る</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/28/autossh-failure-to-connect/">autosshが起動スクリプトでうまく動かない訳</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/28/preview-md/">mdファイルのプレビュー</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/25/read-env-in-init-dot-d/">起動スクリプトで環境変数を読み込む</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/02/23/init-dot-d-script/">init.dスクリプトを書いてみる</a>
      </li>
    
  </ul>
</section>

&#8211;>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Masakazu Miyamoto -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
