
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>mbedでedge deviceを作ってみる（という予定） - MQTT and &#8230;</title>
  <meta name="author" content="Masakazu Miyamoto">

  
  <meta name="description" content="RaspberryPiでエッジデバイスを作って、実際にデプロイしてみました。今のところ順調にデータを送ってくれています。しかしながら、やっぱりlinuxはちょっと重たい感じもするし、値段はともかくオーバースペックという感もあります。 以前予定していた通り、mbedでの開発を考えてみました。 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mm011106.github.io/blog/2016/01/23/installation-of-mbedos/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
   <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="MQTT and ..." type="application/atom+xml">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">

<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=Lato:400,100,100italic,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Lora:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:200,300,400,500,600,700,900' rel='stylesheet' type='text/css'>




  

  <style>html{background: url(/images/background.png) no-repeat center center fixed;-webkit-background-size: cover;-moz-background-size: cover;-o-background-size: cover;background-size: cover;}</style>
</head>

<body   >
  <header role="banner"><hgroup>
</hgroup>

</header>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">mbedでedge deviceを作ってみる（という予定）</h1>
    
    
      <p class="meta">
        








  



<time datetime="2016-01-23T19:43:05+09:00" pubdate data-updated="true">2016 / 01 / 23</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>RaspberryPiでエッジデバイスを作って、実際にデプロイしてみました。今のところ順調にデータを送ってくれています。しかしながら、やっぱりlinuxはちょっと重たい感じもするし、値段はともかくオーバースペックという感もあります。</p>

<p>以前予定していた通り、mbedでの開発を考えてみました。これからならmbedOSベースだろうということで、とりあえずはmbedOSに慣れてみよう、ということで。。。。</p>

<!-- more -->


<p>一昨年の11月にリリースされると聞いていたので楽しみにしていましたが、現在<a href="https://www.mbed.com/en/development/software/mbed-os/releases/">TechnologyPreview</a>のようです。</p>

<h2>mbedOSを導入</h2>

<p>mbedのwebにある<a href="https://docs.mbed.com/docs/getting-started-mbed-os/en/latest/installation/">Installation</a>を見ながら進めます。ホストはMacOSです。<br/>
ここでは、直接インストールするのではなく、Dockerを使ってみます。<br/>
私の理解では、Dockerは実行環境を仮想化する仕組みで、実際の計算機の実行環境と全く別に設定された「コンテナ」とよばれる環境中で作成したアプリケーションを実行できるものです。こうすることで、特定のアプリケーションを動かすための実行環境を使っている開発環境と別に用意できるため、開発環境上でのソフトウエアのコンフリクトを防げるとともに、「コンテナ」をそのまま実際の実行環境に移行できるので「開発時の環境と実行時の環境を全く同じ」にできます。</p>

<h3>1. dockerを導入</h3>

<p><a href="https://www.docker.com/docker-toolbox">docker</a>のwebからMac版をダウンロードしてインストール。<br/>
インストール途中で「起動してみてもいいよ」的な状態になるので、とりあえず無視して終了。</p>

<h3>2. docker 起動</h3>

<p>Launchpadから「Docker Quickstart Terminal」を起動すると、クジラのアスキーアートとともに起動。<br/>
何がなんだか解らないので、tutorialにある</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ docker run hello-world</span></code></pre></td></tr></table></div></figure>


<p>を実行してみると、</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>Hello from Docker.
</span><span class='line'>This message shows that your installation appears to be working correctly.
</span><span class='line'>
</span><span class='line'>To generate this message, Docker took the following steps:
</span><span class='line'> 1. The Docker client contacted the Docker daemon.
</span><span class='line'> 2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
</span><span class='line'> 3. The Docker daemon created a new container from that image which runs the
</span><span class='line'>    executable that produces the output you are currently reading.
</span><span class='line'> 4. The Docker daemon streamed that output to the Docker client, which sent it
</span><span class='line'>    to your terminal.
</span><span class='line'>
</span><span class='line'>To try something more ambitious, you can run an Ubuntu container with:
</span><span class='line'> $ docker run -it ubuntu bash
</span><span class='line'>
</span><span class='line'>Share images, automate workflows, and more with a free Docker Hub account:
</span><span class='line'> https://hub.docker.com
</span><span class='line'>
</span><span class='line'>For more examples and ideas, visit:
</span><span class='line'> https://docs.docker.com/userguide/
</span></code></pre></td></tr></table></div></figure>


<p>ということで、新しい「コンテナ」にhello-worldのイメージを展開してその中にある実行ファイルを実行して、それがDocker clientにこのメッセージを送信、それがターミナルに表示されている、という形になっているとのこと。</p>

<p>インストールはうまく行っているということなので、次に。</p>

<h3>3. yottaのインストール</h3>

<p>mbedOSのアプリケーションはすべてyottaによって作成される必要がある、ということですので、<a href="https://docs.mbed.com/docs/getting-started-mbed-os/en/latest/docker_install/">こちらを参考に</a>yottaをインストールします。</p>

<p><code>$ docker pull mbed/yotta</code></p>

<p>これでdockerのmbed/yottaコンテナを持ってきます。yottaのコマンドをこのコンテナに対して発行することで独立した環境でyottaを実行できる、という感じかとおもいます。<br/>
そのためのスクリプトとして<a href="https://raw.githubusercontent.com/ARMmbed/GettingStartedmbedOS/master/Docs/Scripts/yotta.sh">yotta.sh</a>を使うようです。
これをwgetして、</p>

<p><code>$ ln -s {pathToTheDownloaded}/yotta.sh /usr/local/bin/yotta</code></p>

<p>とすることで、<code>$ yotta ~ ~ ~</code> の形でyottaをコンテナ内で実行できるようになります。</p>

<h2>試してみる</h2>

<p><a href="https://docs.mbed.com/docs/getting-started-mbed-os/en/latest/FirstProjectmbedOS/">blinky</a>を試してみます。といってもmbedOSでサポートされているボードが手元に無いので、途中までですが。。。。</p>

<p>先のリンクにあった通りに実行してみます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ mkdir blinky
</span><span class='line'>$ cd blinky
</span><span class='line'>$ yotta init</span></code></pre></td></tr></table></div></figure>


<p>とすることで、ディレクトリが作業用としてイニシャライズされます。<br/>
モジュール（作ろうとしているアプリケーション）の名前やバージョン、ライブラリなのか実行形式なのか、短い説明、ライセンスを聞かれますので、適宜答えると終了です。</p>

<p>次に、ターゲット環境を設定。
現状、おなじみのmbedデバイスはあまりサポートされていないようです。<br/>
次のコマンドでターゲットの設定ファイルがリストアップされます。</p>

<p><code>$ yotta search target</code></p>

<p>といっても、あまり見通しのよいリストではない感じですね。
ここでは、サンプル通り</p>

<p><code>$ yotta target frdm-k64f-gcc</code></p>

<p>としてみます。mbedアカウントのログインが必要のようです。コンソールに出てくるURLをコピーしてブラウザでログインすると処理が進みます。</p>

<p>しばらくして、ダウンロードとデプロイが完了したあとに、チェックしてみます。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ yotta target
</span><span class='line'>frdm-k64f-gcc 2.0.0
</span><span class='line'>kinetis-k64-gcc 2.0.0
</span><span class='line'>mbed-gcc 1.1.0</span></code></pre></td></tr></table></div></figure>


<p>なにやら設定されたようです。</p>

<p>次にdependenciesをインストールします。ライブラリ、ということでしょうか。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ yotta install mbed-drivers
</span><span class='line'>info: get versions for mbed-drivers
</span><span class='line'>info: download mbed-drivers@0.11.8 from the public module registry
</span><span class='line'>info: dependency mbed-drivers: ~0.11.8 written to module.json
</span><span class='line'>info: get versions for mbed-hal
</span><span class='line'>info: download mbed-hal@1.2.1 from the public module registry
</span><span class='line'>info: get versions for cmsis-core
</span><span class='line'>info: download cmsis-core@1.1.1 from the public module registry
</span><span class='line'>info: get versions for ualloc
</span><span class='line'>info: download ualloc@1.0.3 from the public module registry
</span><span class='line'>....
</span><span class='line'>....</span></code></pre></td></tr></table></div></figure>


<p>bliknkyのソースコードを用意して、<code>./source/app.cpp</code>として保存します。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cp">#include &quot;mbed-drivers/mbed.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">blinky</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">DigitalOut</span> <span class="n">led</span><span class="p">(</span><span class="n">LED1</span><span class="p">);</span>
</span><span class='line'>    <span class="n">led</span> <span class="o">=</span> <span class="o">!</span><span class="n">led</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;LED = %d </span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">led</span><span class="p">.</span><span class="n">read</span><span class="p">());</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">app_start</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">minar</span><span class="o">::</span><span class="n">Scheduler</span><span class="o">::</span><span class="n">postCallback</span><span class="p">(</span><span class="n">blinky</span><span class="p">).</span><span class="n">period</span><span class="p">(</span><span class="n">minar</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">500</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ビルドしてみます。結構時間がかかります。２分とか。（最初だけかも）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="err">$</span> <span class="n">yotta</span> <span class="n">build</span>
</span><span class='line'><span class="nl">info</span><span class="p">:</span> <span class="n">generate</span> <span class="k">for</span> <span class="nl">target</span><span class="p">:</span> <span class="n">frdm</span><span class="o">-</span><span class="n">k64f</span><span class="o">-</span><span class="n">gcc</span> <span class="mf">2.0.0</span> <span class="n">at</span> <span class="o">/</span><span class="n">yotta_home</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">bliknky</span><span class="o">/</span><span class="n">yotta_targets</span><span class="o">/</span><span class="n">frdm</span><span class="o">-</span><span class="n">k64f</span><span class="o">-</span><span class="n">gcc</span>
</span><span class='line'><span class="n">GCC</span> <span class="n">version</span> <span class="nl">is</span><span class="p">:</span> <span class="mf">4.9.3</span>
</span><span class='line'><span class="o">--</span> <span class="n">The</span> <span class="n">ASM</span> <span class="n">compiler</span> <span class="n">identification</span> <span class="n">is</span> <span class="n">GNU</span>
</span><span class='line'><span class="o">--</span> <span class="n">Found</span> <span class="nl">assembler</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">arm</span><span class="o">-</span><span class="n">none</span><span class="o">-</span><span class="n">eabi</span><span class="o">-</span><span class="n">gcc</span>
</span><span class='line'><span class="o">--</span> <span class="n">Configuring</span> <span class="n">done</span>
</span><span class='line'><span class="o">--</span> <span class="n">Generating</span> <span class="n">done</span>
</span><span class='line'><span class="o">--</span> <span class="n">Build</span> <span class="n">files</span> <span class="n">have</span> <span class="n">been</span> <span class="n">written</span> <span class="nl">to</span><span class="p">:</span> <span class="o">/</span><span class="n">yotta_home</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">bliknky</span><span class="o">/</span><span class="n">build</span><span class="o">/</span><span class="n">frdm</span><span class="o">-</span><span class="n">k64f</span><span class="o">-</span><span class="n">gcc</span>
</span><span class='line'><span class="p">[</span><span class="mi">130</span><span class="o">/</span><span class="mi">130</span><span class="p">]</span> <span class="n">Linking</span> <span class="n">CXX</span> <span class="n">executable</span> <span class="n">source</span><span class="o">/</span><span class="n">bliknky</span>
</span></code></pre></td></tr></table></div></figure>


<p>てな感じで終了。</p>

<p><code>./build/frdm-k64f-gcc/source/</code>に<code>blinky.bin</code>というファイルが出来ていて、それがターゲットの実行ファイル（の転送できる形）のようです。</p>

<p>手元にボードが無いのでここまで。</p>

<p>本筋ではないですが、dockerはかなり便利ですね。インストール作業無し（コンテナを引っ張ってくるだけ）でこれだけのツールがReadyToUseになります。コンテナを作ってくれた人には感謝です。<br/>
大抵は、インストールがうまく行かなくて２、３度はコケてしまうこともあり、場合によってはついにあきらめてしまうこともあるので。。。。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Masakazu Miyamoto</span></span>

      








  



<time datetime="2016-01-23T19:43:05+09:00" pubdate data-updated="true">2016 / 01 / 23</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/mbed/'>mbed</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://mm011106.github.io/blog/2016/01/23/installation-of-mbedos/" data-via="" data-counturl="http://mm011106.github.io/blog/2016/01/23/installation-of-mbedos/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/01/10/edge-device-with-nodejs/" title="Previous Post: milkcocoaにnode.jsでアクセスする">&laquo; milkcocoaにnode.jsでアクセスする</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section id="titles">
  <a href="http://mm011106.github.io" title="MQTT and ..."><img id="logo" src="http://mm011106.github.io/images/logo2.png" /></a>
  <h1 id="site_title"><a href="http://mm011106.github.io" title="MQTT and ...">MQTT and &#8230;</a></h1>
  <h3 id="site_subtitle">My first step to the IoT world.</h3>
</section>

<section id="menu">
  <ul>
    <li><i class="fa fa-home fa-lg"></i><a href="http://mm011106.github.io"> Home </a></li>
    <li><i class="fa fa-calendar fa-lg"></i><a href="http://mm011106.github.io/blog/archives/"> Archives </a></li>
    <li><i class="fa fa-user fa-lg"></i><a href="http://mm011106.github.io/about/"> About </a></li>
    <li><i class="fa fa-rss fa-lg"></i><a href="http://mm011106.github.io/atom.xml"> Feed </a></li>
  </ul>
</section>

<section id="social">
  

  

  

  

  

  
</section>


<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/01/23/installation-of-mbedos/">mbedでedge deviceを作ってみる（という予定）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/10/edge-device-with-nodejs/">milkcocoaにnode.jsでアクセスする</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/06/python-and-trello-api/">TrelloにPythonでアクセスしてみる</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/22/iot-et-2015-day3/">ET/IoT 2015　コンファレンスレポート3日目</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/21/iot-et-2015-day2/">ET/IoT 2015　コンファレンスレポート 2日目</a>
      </li>
    
  </ul>
</section>

<!-- #<section id="titles">
  <a href="http://mm011106.github.io" title="MQTT and ..."><img id="logo" src="http://mm011106.github.io/images/logo2.png" /></a>
  <h1 id="site_title"><a href="http://mm011106.github.io" title="MQTT and ...">MQTT and &#8230;</a></h1>
  <h3 id="site_subtitle">My first step to the IoT world.</h3>
</section>

<section id="menu">
  <ul>
    <li><i class="fa fa-home fa-lg"></i><a href="http://mm011106.github.io"> Home </a></li>
    <li><i class="fa fa-calendar fa-lg"></i><a href="http://mm011106.github.io/blog/archives/"> Archives </a></li>
    <li><i class="fa fa-user fa-lg"></i><a href="http://mm011106.github.io/about/"> About </a></li>
    <li><i class="fa fa-rss fa-lg"></i><a href="http://mm011106.github.io/atom.xml"> Feed </a></li>
  </ul>
</section>

<section id="social">
  

  

  

  

  

  
</section>
 &#8211;>

<h1> test for a linke </h1>

<!-- <section>
  <h1>Test for a link to a new page</h1>
  <ul id="references">
    
      <li class="post">
        <a href="/blog/2016/01/23/installation-of-mbedos/">mbedでedge deviceを作ってみる（という予定）</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/10/edge-device-with-nodejs/">milkcocoaにnode.jsでアクセスする</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/06/python-and-trello-api/">TrelloにPythonでアクセスしてみる</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/22/iot-et-2015-day3/">ET/IoT 2015　コンファレンスレポート3日目</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/21/iot-et-2015-day2/">ET/IoT 2015　コンファレンスレポート 2日目</a>
      </li>
    
  </ul>
</section>

&#8211;>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - Masakazu Miyamoto -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
